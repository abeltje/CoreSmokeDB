#! /usr/bin/perl
use warnings;
use strict;
use lib 'lib';

use Dancer;

use Test::Smoke::Gateway::Schema;
use Test::Smoke::Gateway;
my $gw = Test::Smoke::Gateway->new(
    schema => Test::Smoke::Gateway::Schema->connect(
        'dbi:Pg:host=localhost;database=tsgateway',
        'tsgateway',
        'TSg4t3w4y'
    ),
);

set log         => 'debug';
#set logger      => 'console';
set show_errors => 1;
set warnings    => 1;
set views => path(dirname(__FILE__), 'templates');

post '/report' => sub {
    my $data = from_json(params->{'json'});

    my $new_report = $gw->post_report($data);

    header 'content-type', 'text/plain';
    template 'report' => { report => $new_report };
};

get '/report/:id' => sub {
    my $report = $gw->get_report(params->{'id'});

#    header 'content-type', 'text/plain; charset=utf-8';
    template 'report' => {
        report  => $report,
        version => $Test::Smoke::Gateway::VERSION,
    };
};

get '/search' => sub {
    template 'search' => {
        search  => $gw->search_blank(),
        title   => 'TSDbSearch',
        version => $Test::Smoke::Gateway::VERSION,
    };
};

get '/' => sub {
    forward '/search';
};

dance();
