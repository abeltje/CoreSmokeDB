#! /usr/bin/perl
use warnings;
use strict;
use lib 'lib';

use Dancer;

use Test::Smoke::Gateway::Schema;
use Test::Smoke::Gateway;
my $gw = Test::Smoke::Gateway->new(
    schema => Test::Smoke::Gateway::Schema->connect(
        'dbi:Pg:host=gromit;database=tsgateway',
        'tsgateway',
        'TSg4t3w4y'
    ),
);

set log         => 'debug';
#set logger      => 'console';
set show_errors => 1;
set warnings    => 1;
set views => path(dirname(__FILE__), 'templates');

post '/report' => sub {
    my $data = from_json(params->{'json'});

    my $new_report = $gw->post_report($data);

    header 'content-type', 'text/plain';
    template 'report' => {
        report => $new_report
    };
};

get '/report/:id' => sub {
    my $report = $gw->get_report(params->{'id'});

    template 'report' => {
        report   => $report,
        title    => $report->title,
        version  => $Test::Smoke::Gateway::VERSION,
        thisyear => 1900 + (localtime)[5],
    };
};

get '/logfile/:id' => sub {
    my $report = $gw->get_report(params->{'id'});

    template 'logfile' => {
        report   => $report,
        title    => $report->title,
        version  => $Test::Smoke::Gateway::VERSION,
        thisyear => 1900 + (localtime)[5],
    };
};

post '/search' => sub {
    template 'search' => {
        search   => $gw->search({params}),
        title    => 'Test::Smoke Database Search',
        version  => $Test::Smoke::Gateway::VERSION,
        thisyear => 1900 + (localtime)[5],
    };
};

get '/search' => sub {
    template 'search' => {
        search   => $gw->search(),
        title    => 'Test::Smoke Database Search',
        version  => $Test::Smoke::Gateway::VERSION,
        thisyear => 1900 + (localtime)[5],
    };
};

get '/api/reports_from_date/:epoch' => sub {
    header 'content-type', 'application/json';

    template 'rawjson' => {
        json => $gw->api_get_reports_from_date(params->{epoch}),
    },
    {
        layout => undef,
    };
};

get '/api/report_data/:id' => sub {
    header 'content-type', 'application/json';

    template 'rawjson' => {
        json => $gw->api_get_report_data(params->{id}),
    },
    {
        layout => undef,
    };
};

get '/' => sub {
    forward '/search';
};

dance();
